language: r
r:
  - release
dist: trusty  # ubuntu 14.04 has additional libraries available
sudo: required
cache: false
warnings_are_errors: false

# install debian libraries to match R-servers
# update pre-installed packages to latest versions
before_install:
  - sudo apt-get -qq update
  - sudo apt-get install -y libgdal-dev libproj-dev python-protobuf libprotoc-dev libprotobuf-dev libv8-dev librsvg2-dev
  - rcode="res<-devtools::test(); "
  - rcode+="df <- as.data.frame(res); "
  - rcode+='pass <- sum(df$failed)==0 && all(!df$error); '
  - rcode+="write.csv(df, file='test_results.csv'); "
  - rcode+="quit(status=1-pass, save='no');"

r_packages:
  - roxygen2
  - covr

r_github_packages:
  - Displayr/flipDevTools
  - Displayr/flipExampleData

script:
  - R CMD build --no-manual --no-build-vignettes --no-resave-data .
  - R CMD check --as-cran --no-manual --no-build-vignettes --no-tests *.tar.gz
  - Rscript -e 'install.packages("webshot"); webshot::install_phantomjs()'
  - if [ -d tests/testthat ]; then
    Rscript --default-packages='datasets,utils,grDevices,graphics,stats,methods' -e "$rcode";
    fi

deploy:
  provider: releases
  api_key:
    secure: YDyOuqESuOFAZugXF+pdyc1qvvQonf3QKA9hqco7U4rjvrfqXKF+OnKh3phYLW1W/clj5TBWOqj0eL1LnMjuD4ozHTSeHcKDJohRoqRUxssak3vqJLWJzZi4ecqYISVbFW2wBGpBMAfl1jd3v5nFkfL51Qrgefayp56EmVrGs+QSNL04KCwd343Npt9f8LV044qhzgFX/dMaNKzI1bqKpQ6yg5xMYBEP9H98ro0iwkLdbdi36HUA9w28OlNFdLBKbd9RNW2KXEBaGa6w3Fch6b3ERRk7v7E1XkxHvAuUigPzxJtXHg93E4Qo2he+XSM/+mF4gB34OhOtYYqHjeYNU83kv0xHm25U1rFxkdb+nm2eDW6yAXT+b5QktV3vzc7a+6M1SsyeaQpzN1+ZNZsuCD2lGl/9NkpDTiyAQukb15+kpsjCMCNYypTeFlNfIYo1x5kqg2bRZL/OGTyly4m4GwGpbyYKVD521gvgGLysbI5t2vHeFDGAbTm7noihh1+n5V95bKwWcEghTyw4t1lbKktEHz/RyuzP0o0l5GTtciKOwAannpr/b+n3oIbKRlyG7KXDiNL/UVLCjmJm3OO7NM04FuX1eQyVS911HQ6EhRz0U6wZaJcpdv7ngxLY2zOHN7pu30vOrgwWxW8Vyjiu9Xt8r+YTr4cY8BAXdOS5KXc=
  file_glob: true
  file: tests/testthat/snapshots/*
  overwrite: true
  on:
    repo: Displayr/flipChartTests
    branch: master
  skip_cleanup: true


#notifications:
#  slack:
#    rooms:
#      - displayr:FTgSTNHC2rpanhJMGTKMwZXM#github-notifications
#    template:
#      - "Build <%{build_url}|#%{build_number}> %{result} in %{repository_name}@%{branch} by %{author}: <%{compare_url}|%{commit_message}>"
#    on_success: change
#    on_failure: always

# Warning notifications and downstream package builds are implemented
# by calling R functions so they can be updated in this package without
# committing a new change to .travis.yml in each repository
#after_success:
#  - Rscript -e "require(flipDevTools); NotifyWarnings(); TriggerDownstreamBuilds()"
#  - travis_wait Rscript -e "flipDevTools::CheckCoverage()"
